import { AssetAmount, IAssetAmountMetadata } from "@sundaeswap/asset";
import { TConditionDatumArgs } from "../DatumBuilders/DatumBuilder.V3.class.js";
import {
  EPoolCoin,
  TDestination,
  TDestinationAddress,
  TOrderAddressesArgs,
  TUTXO,
} from "./datumbuilder.js";
import { IPoolData } from "./queryprovider.js";
import { ITxBuilderReferralFee } from "./txbuilders.js";

/**
 * The base config that all configs extend.
 */
export interface IBaseConfig {
  referralFee?: ITxBuilderReferralFee;
}

/**
 * The common arguments for any valid order.
 */
export interface IOrderConfigArgs extends IBaseConfig {
  pool: IPoolData;
  orderAddresses: TOrderAddressesArgs;
  ownerAddress?: string;
}

/**
 * An enum to represent a Swap order type.
 */
export enum ESwapType {
  MARKET = "MARKET",
  LIMIT = "LIMIT",
}

/**
 * An interface that represents a market order
 * swap with required slippage.
 */
export interface IMarketSwap {
  type: ESwapType.MARKET;
  slippage: number;
}

/**
 * An interface that represents a limit order
 * swap with required minimum receivable.
 */
export interface ILimitSwap {
  type: ESwapType.LIMIT;
  minReceivable: AssetAmount<IAssetAmountMetadata>;
}

/**
 * A union type to represent all possible swap types.
 */
export type TSwapType = IMarketSwap | ILimitSwap;

/**
 * The arguments configuration for building a valid Swap.
 */
export interface ISwapConfigArgs extends IOrderConfigArgs {
  suppliedAsset: AssetAmount<IAssetAmountMetadata>;
  swapType: TSwapType;
  /**
   * Optional extra ADA (lovelace) added to the order deposit. Use when the order output
   * will fund a subsequent execution (e.g. strategy second swap). If omitted, defaults to 0n.
   */
  feePadding?: bigint;
}

/**
 * The arguments configuration for building a valid Deposit.
 */
export interface IDepositConfigArgs extends IOrderConfigArgs {
  suppliedAssets: [
    AssetAmount<IAssetAmountMetadata>,
    AssetAmount<IAssetAmountMetadata>,
  ];
}

/**
 * The arguments configuration for building a valid cancellation transaction.
 */
export interface ICancelConfigArgs extends IBaseConfig {
  ownerAddress?: string;
  utxo: TUTXO;
}

/**
 * The arguments configuration for building a valid Deposit.
 */
export interface IZapConfigArgs extends IOrderConfigArgs {
  suppliedAsset: AssetAmount<IAssetAmountMetadata>;
  zapDirection: EPoolCoin;
  swapSlippage?: number;
}

/**
 * The arguments configuration for building a valid Withdraw.
 */
export interface IWithdrawConfigArgs extends Omit<IOrderConfigArgs, "pool"> {
  suppliedLPAsset: AssetAmount<IAssetAmountMetadata>;
}

/**
 * The arguments configuration for building a valid Strategy.
 */
export interface IStrategyConfigArgs
  extends Omit<IOrderConfigArgs, "orderAddresses"> {
  suppliedAsset: AssetAmount<IAssetAmountMetadata>;
  destination: TDestination;
  ownerAddress: string;
  authSigner?: string;
  authScript?: string;
  /**
   * The number of executions planned for this strategy.
   * Used to calculate the total scooper fees required.
   * Defaults to 1n if not provided.
   */
  executionCount?: bigint;
}

export interface IStrategyConfigInputArgs
  extends Omit<IStrategyConfigArgs, "ownerAddress"> {
  ownerAddress?: string;
}

/**
 * Configuration interface for fee basis points in liquidity pools.
 * Fees are represented as basis points (1 basis point = 0.01%).
 *
 * In trading terminology:
 * - "bid" typically refers to buying (swapping into the pool)
 * - "ask" typically refers to selling (swapping out of the pool)
 *
 * For example, a value of 30n represents 0.30% (30 basis points).
 */
export interface IFeesConfig {
  /**
   * The ask fee in basis points, applied when swapping out of the pool.
   */
  ask: bigint;

  /**
   * The bid fee in basis points, applied when swapping into the pool.
   */
  bid: bigint;
}

/**
 * Interface describing the method arguments for creating a pool
 * in the V3 Pool Contract.
 */
export interface IMintPoolConfigArgs extends IBaseConfig {
  assetA: AssetAmount<IAssetAmountMetadata>;
  assetB: AssetAmount<IAssetAmountMetadata>;
  fees: bigint | IFeesConfig;
  ownerAddress: string;
  // Defaults to immediately.
  marketOpen?: bigint;
  /**
   * This will send a percentage of LP tokens generated by creating the pool
   * to the SundaeSwap Treasury wallet.
   */
  donateToTreasury?: bigint;
  /**
   * The fee manager address for the pool. If not provided, defaults to null.
   */
  feeManager?: string;
  condition?: string;
  conditionDatumArgs?: TConditionDatumArgs;
  linearAmplification?: bigint;
  linearAmplificationManager?: string;
  protocolFees?: bigint | IFeesConfig;
}

/**
 * Interface describing migrations for liquidity
 * positions in a user's wallet.
 */
export interface IMigrateLiquidityConfig {
  withdrawConfig: IWithdrawConfigArgs & { pool: IPoolData };
  depositPool: IPoolData;
  newLockedAssets?: Record<string, IAssetAmountMetadata & { amount: bigint }>;
}

/**
 * Interface describing migrations for locked liquidity
 * positions in the Yield Farming contract.
 */
export interface IMigrateYieldFarmingLiquidityConfig {
  ownerAddress: TDestinationAddress;
  existingPositions?: TUTXO[];
  migrations: {
    withdrawPool: IPoolData;
    depositPool: IPoolData;
  }[];
}

/**
 * Type interface to describe the Strategy config type.
 */
export type TUpdateStrategy = {
  type: "Strategy";
  args: IStrategyConfigArgs;
};

/**
 * Type interface to describe the Swap config type.
 */
export type TUpdateSwap = {
  type: "Swap";
  args: ISwapConfigArgs;
};

/**
 * Union to bind together the different config types.
 */
export type TUpdateConfig = TUpdateSwap | TUpdateStrategy;

/**
 * Interface for updating an order with a set of considered
 * configuration types.
 */
export interface IUpdateArgs {
  cancelConfig: ICancelConfigArgs;
  updateConfig: TUpdateConfig;
}
